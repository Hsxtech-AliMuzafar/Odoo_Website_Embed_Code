<!-- Leaflet (OpenStreetMap) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- MarkerCluster (group markers when zoomed out) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<style>
    .store-locator {
        display: grid;
        grid-template-columns: 380px 1fr;
        gap: 16px;
        align-items: start;
        width: 100%;
        max-width: 1400px;
        margin: 0 auto;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
    }

    .store-panel {
        border: 1px solid rgba(0, 0, 0, .12);
        border-radius: 12px;
        overflow: hidden;
        background: #fff;
    }

    .store-panel header {
        padding: 12px 12px 10px;
        border-bottom: 1px solid rgba(0, 0, 0, .08);
    }

    .store-panel h3 {
        margin: 0 0 8px;
        font-size: 14px;
        font-weight: 800;
        letter-spacing: .5px;
        text-transform: uppercase;
        color: #720528;
    }

    .store-panel input {
        width: 100%;
        padding: 10px 10px;
        border: 1px solid rgba(0, 0, 0, .15);
        border-radius: 10px;
        outline: none;
    }

    .store-list {
        max-height: 560px;
        overflow: auto;
    }

    .store-item {
        padding: 10px 12px;
        border-bottom: 1px solid rgba(0, 0, 0, .06);
        cursor: pointer;
    }

    .store-item:hover {
        background: rgba(0, 0, 0, .03);
    }

    .store-code {
        font-weight: 900;
        font-size: 13px;
        margin-bottom: 4px;
        color: #720528;
    }

    .store-addr {
        font-size: 12px;
        opacity: .85;
        line-height: 1.35;
    }

    #storeMap {
        height: 650px;
        border-radius: 12px;
        border: 1px solid rgba(0, 0, 0, .12);
        overflow: hidden;
    }

    .status {
        font-size: 12px;
        opacity: .75;
        margin-top: 8px;
        line-height: 1.35;
    }

    /* Optional: hover pop for car icon */
    .leaflet-marker-icon svg {
        transition: transform .2s ease;
    }

    .leaflet-marker-icon:hover svg {
        transform: scale(1.12);
    }

    /* Brand-colored cluster bubbles */
    .marker-cluster-small,
    .marker-cluster-medium,
    .marker-cluster-large {
        background-color: rgba(114, 5, 40, 0.25) !important;
    }

    .marker-cluster-small div,
    .marker-cluster-medium div,
    .marker-cluster-large div {
        background-color: #720528 !important;
        color: #fff !important;
        font-weight: 900;
    }

    @media (max-width:980px) {
        .store-locator {
            grid-template-columns: 1fr;
        }

        .store-list {
            max-height: 240px;
        }

        #storeMap {
            height: 520px;
        }
    }
</style>

<div class="store-locator">
    <aside class="store-panel">
        <header>
            <h3>Store Locator</h3>
            <input id="storeSearch" type="text" placeholder="Search by city, ZIP, store code..." />
            <div id="status" class="status">Loading stores…</div>
        </header>
        <div id="storeList" class="store-list"></div>
    </aside>

    <div id="storeMap"></div>
</div>

<script>

    // ========= 2) MAP SETUP =========
    const map = L.map("storeMap", { scrollWheelZoom: false }).setView([39.8, -86.1], 7);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    const statusEl = document.getElementById("status");
    const listEl = document.getElementById("storeList");
    const searchEl = document.getElementById("storeSearch");

    // ========= 3) CAR ICON (your SVG, recolored #720528) =========
    const carIcon = L.divIcon({
        className: "",
        iconSize: [44, 44],
        iconAnchor: [22, 44],
        popupAnchor: [0, -40],
        html: `
      <svg width="44" height="44" viewBox="-20 0 190 190" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path fill-rule="evenodd" clip-rule="evenodd"
          d="M117 85.5L114.41 108.17L88.66 108.35L86.25 85.5C80.15 85.5 77.89 82.35 77.89 76.16H86.25C86.32 71.47 86.89 65.51 91.52 65.47C91.52 65.47 91.52 76.16 101.64 76.16C111.76 76.16 111.75 65.47 111.75 65.47C116.38 65.47 116.96 71.47 117.02 76.16H125.38C125.38 82.35 123.13 85.5 117 85.5ZM81.38 90C81.83 93.55 83.99 112.62 83.99 112.62L101.21 114L103 147L93.25 146.63L91.25 127.22H83.57L82.22 147.39L72.45 147.32L71.08 127.52L42.29 126.72L40.5 147.53L32.35 147.39L28.46 118.53L35.4 106.41V87.06C35.4 79.67 38.58 76 46.8 76C51.57 76 58.41 76.14 71.72 76.14C71.72 83.55 76.67 90 81.38 90ZM59.08 147.49L50.78 147.76L46.27 131L57.18 131.47L59.08 147.49Z"
          fill="#720528"
        />
      </svg>
    `
    });

    // ========= 4) CLUSTER GROUP =========
    const clusterGroup = L.markerClusterGroup({
        // tweak these if you want bigger/smaller clusters
        maxClusterRadius: 50,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false
    });
    map.addLayer(clusterGroup);

    // ========= 5) GEOCODING WITH CACHE + THROTTLE =========
    const CACHE_KEY = "in_store_locator_geocode_v2";
    const cache = JSON.parse(localStorage.getItem(CACHE_KEY) || "{}");
    const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

    async function geocodeAddress(address) {
        if (cache[address]) return cache[address];

        const url =
            "https://nominatim.openstreetmap.org/search?format=json&limit=1&q=" +
            encodeURIComponent(address);

        const res = await fetch(url, { headers: { "Accept": "application/json" } });
        const data = await res.json();
        if (!data || !data.length) return null;

        const hit = { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
        cache[address] = hit;
        localStorage.setItem(CACHE_KEY, JSON.stringify(cache));
        return hit;
    }

    function renderList(items, markerIndexByCode) {
        listEl.innerHTML = "";
        items.forEach((s) => {
            const row = document.createElement("div");
            row.className = "store-item";
            row.innerHTML = `
        <div class="store-code">${s.code}</div>
        <div class="store-addr">${s.address}</div>
      `;
            row.addEventListener("click", () => {
                const marker = markerIndexByCode.get(s.code);
                if (marker) {
                    // If marker is clustered, zoom to it and open its popup once visible
                    clusterGroup.zoomToShowLayer(marker, () => {
                        map.setView(marker.getLatLng(), 14, { animate: true });
                        marker.openPopup();
                    });
                }
            });
            listEl.appendChild(row);
        });
    }

    async function init() {
        statusEl.textContent = "Geocoding store addresses (first load may take a bit)…";

        const markerIndexByCode = new Map();
        clusterGroup.clearLayers();

        for (let i = 0; i < STORES.length; i++) {
            const store = STORES[i];
            const geo = await geocodeAddress(store.address);

            if (geo) {
                const marker = L.marker([geo.lat, geo.lng], { icon: carIcon });
                marker.bindPopup(`<b>${store.code}</b><br>${store.address}`);

                markerIndexByCode.set(store.code, marker);
                clusterGroup.addLayer(marker);
            }

            statusEl.textContent = `Loaded ${i + 1} / ${STORES.length} stores…`;
            await sleep(650); // slightly faster; still polite
        }

        const allBounds = clusterGroup.getBounds();
        if (allBounds.isValid()) {
            map.fitBounds(allBounds, { padding: [30, 30] });
            statusEl.textContent = `Loaded ${markerIndexByCode.size} stores.`;
        } else {
            statusEl.textContent = "No stores could be geocoded. Check address format.";
        }

        renderList(STORES, markerIndexByCode);

        searchEl.addEventListener("input", () => {
            const q = searchEl.value.trim().toLowerCase();
            const filtered = !q
                ? STORES
                : STORES.filter(s => (s.code + " " + s.address).toLowerCase().includes(q));

            renderList(filtered, markerIndexByCode);
            statusEl.textContent = q
                ? `Showing ${filtered.length} matches.`
                : `Loaded ${markerIndexByCode.size} stores.`;
        });
    }

    init();
</script>